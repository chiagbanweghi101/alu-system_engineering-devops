#!/usr/bin/env bash
# This script configures Nginx to ensure it is running and listening on port 80 on all active IPv4 IPs.

# Ensure nginx is installed
if ! command -v nginx &> /dev/null
then
    echo "Nginx not found, installing it..."
    apt update
    apt install -y nginx
fi

# Start the Nginx service
echo "Starting Nginx..."
systemctl start nginx

# Ensure Nginx is listening on port 80 on all IPv4 addresses
echo "Configuring Nginx to listen on port 80 for all IP addresses..."
sed -i 's/listen 127.0.0.1:80;/listen 0.0.0.0:80;/' /etc/nginx/sites-available/default

# Restart the Nginx service to apply changes
echo "Restarting Nginx..."
systemctl restart nginx

# Check if nginx is listening on port 80
echo "Checking if Nginx is listening on port 80..."
ss -tuln | grep ':80' > /dev/null
if [ $? -ne 0 ]; then
    echo "Nginx is not listening on port 80."
    exit 1
else
    echo "Nginx is successfully listening on port 80."
fi

# Ensure Nginx is responding with HTTP 200 status
echo "Checking HTTP response status on port 80..."
http_status=$(curl --silent --write-out "%{http_code}" --output /dev/null http://localhost:80)

# Check if the status is 200
if [ "$http_status" -ne 200 ]; then
    echo "Nginx is not returning HTTP 200 status on port 80, but returned $http_status"
    exit 1
fi

# If everything is good
echo "Nginx is running, listening on port 80, and returned HTTP 200 status."

