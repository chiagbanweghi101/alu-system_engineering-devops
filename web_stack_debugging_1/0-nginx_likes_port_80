#!/usr/bin/env bash
# This script configures Nginx to ensure it is running and listening on port 80 on all active IPv4 IPs.

# Ensure nginx is installed
if ! command -v nginx &> /dev/null
then
    apt update
    apt install -y nginx
fi

# Start the Nginx service
systemctl start nginx

# Ensure Nginx is listening on port 80 on all IPv4 addresses
sed -i 's/listen 127.0.0.1:80;/listen 0.0.0.0:80;/' /etc/nginx/sites-available/default

# Restart the Nginx service to apply changes
systemctl restart nginx

# Check if nginx is listening on port 80
ss -tuln | grep ':80' > /dev/null
if [ $? -ne 0 ]; then
    echo "Nginx is not listening on port 80"
    exit 1
fi

# Ensure Nginx is running and responding with HTTP 200 status
http_status=$(curl --silent --write-out "%{http_code}" --output /dev/null http://localhost:80)

# Check if the status is 200
if [ "$http_status" -ne 200 ]; then
    echo "Nginx is not returning HTTP 200 status on port 80, but returned $http_status"
    exit 1
fi

# If everything is good
echo "Nginx is running and listening on port 80 with HTTP 200 status."

